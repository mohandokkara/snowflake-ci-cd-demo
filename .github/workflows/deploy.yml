name: Multi Environment Deploy

on:
  push:
    branches:
      - develop
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set environment variables
        id: set_env
        run: |
          if [[ "${GITHUB_REF##*/}" == "develop" ]]; then
            echo "USER=${{ secrets.DEV_SNOWFLAKE_USERNAME }}" >> $GITHUB_ENV
            echo "PASSWORD=${{ secrets.DEV_SNOWFLAKE_PASSWORD }}" >> $GITHUB_ENV
            echo "DATABASE=${{ secrets.DEV_SNOWFLAKE_DATABASE }}" >> $GITHUB_ENV
            echo "SCHEMA=${{ secrets.DEV_SNOWFLAKE_SCHEMA }}" >> $GITHUB_ENV
          else
            echo "USER=${{ secrets.PROD_SNOWFLAKE_USERNAME }}" >> $GITHUB_ENV
            echo "PASSWORD=${{ secrets.PROD_SNOWFLAKE_PASSWORD }}" >> $GITHUB_ENV
            echo "DATABASE=${{ secrets.PROD_SNOWFLAKE_DATABASE }}" >> $GITHUB_ENV
            echo "SCHEMA=${{ secrets.PROD_SNOWFLAKE_SCHEMA }}" >> $GITHUB_ENV
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Snowflake Connector
        run: pip install snowflake-connector-python

      - name: Execute SQL
        run: |
          python <<EOF
          import snowflake.connector
          import os

          conn = snowflake.connector.connect(
              user=os.environ["USER"],
              password=os.environ["PASSWORD"],
              account="${{ secrets.SNOWFLAKE_ACCOUNT }}",
              warehouse="${{ secrets.SNOWFLAKE_WAREHOUSE }}",
              database=os.environ["DATABASE"],
              schema=os.environ["SCHEMA"]
          )

          cursor = conn.cursor()
          with open("sql/create_table.sql") as f:
              sql = f.read()

          for stmt in sql.split(";"):
              if stmt.strip():
                  cursor.execute(stmt)

          cursor.close()
          conn.close()
          print("Deployment successful")
          EOF
