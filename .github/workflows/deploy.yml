name: Multi Environment Deploy

on:
  push:
    branches:
      - develop
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Snowflake Connector
        run: pip install snowflake-connector-python

      - name: Execute SQL Files
        run: |
          python <<EOF
          import snowflake.connector
          import glob
          import os

          branch = os.environ.get("GITHUB_REF").split("/")[-1]
          print(f"Deploying branch: {branch}")

          if branch == "develop":
              user = "${{ secrets.DEV_SNOWFLAKE_USERNAME }}"
              password = "${{ secrets.DEV_SNOWFLAKE_PASSWORD }}"
              database = "${{ secrets.DEV_SNOWFLAKE_DATABASE }}"
              schema = "${{ secrets.DEV_SNOWFLAKE_SCHEMA }}"
              warehouse = "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
          else:
              user = "${{ secrets.PROD_SNOWFLAKE_USERNAME }}"
              password = "${{ secrets.PROD_SNOWFLAKE_PASSWORD }}"
              database = "${{ secrets.PROD_SNOWFLAKE_DATABASE }}"
              schema = "${{ secrets.PROD_SNOWFLAKE_SCHEMA }}"
              warehouse = "${{ secrets.SNOWFLAKE_WAREHOUSE }}"

          conn = snowflake.connector.connect(
              user=user,
              password=password,
              account="${{ secrets.SNOWFLAKE_ACCOUNT }}"
          )

          cursor = conn.cursor()

          # âœ… Force warehouse activation (fixes your error)
          cursor.execute(f"USE WAREHOUSE {warehouse}")
          cursor.execute(f"USE DATABASE {database}")
          cursor.execute(f"USE SCHEMA {schema}")

          print("Warehouse, DB and Schema activated")

          # Execute ALL SQL files
          for file in sorted(glob.glob("sql/*.sql")):
              print(f"Executing {file}")

              with open(file) as f:
                  sql = f.read()

              for stmt in sql.split(";"):
                  if stmt.strip():
                      cursor.execute(stmt)

          cursor.close()
          conn.close()

          print("Deployment successful ðŸš€")
          EOF
